@using System;
@using System.Globalization;
@model CustomersAViewModel
@{
    string[] msgAddProducts = Model.Localizer["page.addArticlesMsg"].ToString().Split('.');
    List<string> monthList = Model.Localizer["monthpicker.monthList"].ToString().Split(",").ToList();
    DateTime startDate = DateTime.Parse(Model.MonthStart.ToString() + "-" + Model.YearStart.ToString());
    DateTime endDate = DateTime.Parse(Model.MonthEnd.ToString() + "-" + Model.YearEnd.ToString());
    int? monthStart = Model.MonthStart;
    int? yearStart = Model.YearStart;
    int? monthEnd = Model.MonthEnd;
    int? yearEnd = Model.YearEnd;
    NumberFormatInfo nfiDecimalDB = new CultureInfo(Model.DecimalFormatSelected, false).NumberFormat;

}
<style>
    .spinner-loading-list {
        position: fixed;
        text-align: center;
        z-index: 20;
        width: 64px;
        height: 64px;
        display:none;
    }

    #overlay {
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.5);
        z-index: 10;
        display:none;
    }
</style>

@if (Model.Products.Count == 0 && (Model.SelectedStatus == 4 || Model.SelectedStatus == 0) && Model.SearchedProductCode == null && Model.SearchedProductDescription == null)
{
    <div class="text-center">
        <span class="fs-6">@msgAddProducts[0]  <br>@msgAddProducts[1] </span>
    </div>
}
else
{
    <div id="overlay"></div>
    <input id="currentArticle" type="text" hidden asp-for="CollapsedSubtableId" />
    <input id="currentPage" type="text" asp-for="TargetedPage" hidden />
    <input value="@Model.SaveTypeSelected" id="defaultSaveType" hidden />
    <!-- Button trigger modal -->
    <button type="button" class="btn btn-primary invisible" data-bs-toggle="modal" data-bs-target="#staticBackdrop" id="openForecastModal">
        Launch static backdrop modal
    </button>

    <!-- Modal -->
    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel"></h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    @Model.Localizer["modal.Sentence"]
                </div>
                <div class="modal-footer d-flex justify-content-center">
                    <button type="button" class="btn btn-secondary width-150" id="continueEditionModal"> @Model.Localizer["modal.btnContinue"]</button>
                    <button type="button" class="btn forecast-cancel-button-style width-150" id="cancelEditionModal">@Model.Localizer["page.cancelbtn"]</button>
                    <button type="button" class="btn forecast-button-style width-150" id="saveForecastModal">@Model.Localizer["page.confirmbtn"]</button>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="d-flex justify-content-center">
            <div class="spinner-border spinner-loading-list" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <div class="card rounded-2 p-2 bg-light overflow-auto " style="margin-left: 11px;">
            <div class="tableFixed ">
                <table class="table table-sm table-striped table-hover table-bordered m-0 datagrid" id="tableK">
                    <thead class="header">
                        <tr class="align-middle">
                            <th id="sortProductDescription" scope="col" product-sort="@ViewBag.ProductDescriptionSortParm" class="pointer-cursor" style="min-width: 150px;">
                                <div class="row">
                                    <div class="col-6 d-flex align-items-center ">
                                        @Model.Localizer["tableP.headerProductDescription"]
                                    </div>
                                    <div class="col-6 d-flex flex-column align-items-end">
                                        <i class="fa-solid fa-arrow-up-z-a" id="productNDesc" @if (ViewBag.SortType == "ProductDescription"){<text>active-sort='true'</text>}></i>
                                        <i class="fa-solid fa-arrow-down-a-z" id="productNAsc" @if (ViewBag.SortType == "ProductDescription_desc"){<text>active-sort='true'</text>}></i>
                                    </div>
                                </div>
                            </th>
                            <th id="sortProductCode" scope="col" product-sort="@ViewBag.ProductCodeSAPSortParm" class="pointer-cursor" style="min-width: 100px;">
                                <div class="row">
                                    <div class="col-6 d-flex align-items-center ">
                                        @Model.Localizer["tableP.headerProductCode"]
                                    </div>
                                    <div class="col-6 d-flex flex-column align-items-end">
                                        <i class="fa-solid fa-arrow-up-9-1" id="productCodeSAPDesc" @if (ViewBag.SortType == "CodeSAP")
                                        {
                                            <text>active-sort='true'</text>
                                        }></i>
                                        <i class="fa-solid fa-arrow-down-1-9" id="productCodeSAPAsc" @if (ViewBag.SortType == "CodeSAP_desc")
                                        {
                                            <text>active-sort='true'</text>
                                        }></i>
                                    </div>
                                </div>
                            </th>

                            <th scope="col" style="text-align:center !important"> @Model.Localizer["tableP.headerProductUnit"] </th>
                            <th scope="col" style="text-align:center !important;min-width: 80px;">@Model.Localizer["tableC.headerStatus"]</th>
                            <th id="sortLastUpdate" scope="col" product-sort="@ViewBag.LastUpdateSortParm" class="pointer-cursor" style="min-width: 100px;">
                                <div class="row">
                                    <div class="col-6 d-flex align-items-center">
                                        @Model.Localizer["tableP.headerLastUpdate"]
                                    </div>
                                    <div class="col-6 d-flex flex-column align-items-end">
                                        <i class="fa-solid fa-arrow-up-9-1" id="lastUpdateDesc" @if (ViewBag.SortType == "")
                                        {
                                            <text>active-sort='true'</text>
                                        }></i>
                                        <i class="fa-solid fa-arrow-down-1-9" id="lastUpdateAsc" @if (ViewBag.SortType == "LastUpdate_desc")
                                        {
                                            <text>active-sort='true'</text>
                                        }></i>
                                    </div>
                                </div>
                            </th>


                            <th style="text-align:center !important">@Model.Localizer["tableC.actions"]</th>

                        </tr>
                        <tr>
                            <th><input type="text" class="form-control position-sticky" placeholder="@Model.Localizer["search.byDescription"]" id="productSearchDescription" asp-for="SearchedProductDescription" /></th>
                            <th><input type="text" class="form-control position-sticky" placeholder="@Model.Localizer["search.byCode"]" id="productSearchCode" asp-for="SearchedProductCode" /></th>
                        
                            <input type="text" id="focusedElement" asp-for="FocusedElementId" hidden />
                          
                            <th></th>
                            <th>
                                <select class="form-select col-4" aria-label="Default select example" id="entryStatusPro" asp-items="@Model.Statuses" asp-for="SelectedStatus">
                                    <option value="4" selected="selected">@Model.Localizer["tableC.headerSortStatus"]</option>
                                </select>
                            </th>
                            <th></th>
                            <th></th>
                        </tr>
                    </thead>
                  
                    <tbody id="myAccordion" class="accordion">

                        @if (Model.Products.Count() == 0 && (Model.SelectedStatus != 4 || Model.ProductFound == false))
                        {
                            <tr><th scope="row" colspan="4">@* Il n'y a pas d'articles pour le statut :  @Model.Statuses.Where(s => s.Value == Model.SelectedStatus.ToString()).First().Text *@ @Model.Localizer["page.noResults"]</th></tr>
                        }
                 
                        else
                        {
                            @foreach (var article in Model.Products)
                            {


                                <tr data-bs-toggle="collapse" data-bs-target="" aria-expanded="false" aria-controls="@article.CodeSAP" class="article-row align-middle">
                                    <td class="productDescription">
                                        @if (article.ListArticlePrevision.Where(a => a.DateModification == DateTime.Now.Date).Count() != 0)
                                        {
                                            <strong>@article.Description</strong>
                                        }
                                        else
                                        {
                                          @article.Description
                                        }

                                       </td>
                                    <td>@article.CodeSAP</td>
                                    <td>@article.Unite</td>
                             
                                    <td><div class="style-status-general @if(article.Statut.Split('_')[1] == "1") {<text>style-status-new</text>} else if(article.Statut.Split('_')[1] == "2") {<text>style-status-make</text>} else { <text>style-status-made</text>}">
                                            @article.Statut.Split('_')[0]   @if (article.Statut.Split('_')[1] == "1")
                                            {
                                                <text></text>
                                            }
                                            else if (article.Statut.Split('_')[1] == "2")
                                            {
                                                <text></text>
                                            }
                                            else
                                            {
                                                <text></text>
                                            }
                                        </div>
                                    </td>
                                    <td>
                                        @if (article.DateModification == null)
                                        {
                                            <text>@Model.Localizer["tableRow.Noforecasts"]</text>
                                        }
                                        else
                                        {
                                            @article.DateModification?.ToString(Model.DateFormatSelected) @if (article.NbJours == 0)
                                            {
                                                <text>,  @Model.Localizer["tableC.today"]</text>
                                            } else{
                                               
                                                    <text>, </text> @article.NbJours <text> @Model.Localizer["tableC.daysAgo"]</text>
                                                    
                                         

                                            }
                                        }
                                    </td>
                                    <td class=" @if (article.Statut.Split('_')[1] == "1") {<text>d-flex justify-content-center align-items-center</text>}">
                                    
                                            <i class="bi bi-eye-fill fs-5 pointer-cursor"></i>

                                        @if (article.Statut.Split('_')[1] == "1")
                                        {
                                            <a class="btn deleteNewProductBtn collapse-link" id="@article.IdArticle" href='@Url.Action("DeleteNewProduct", "ForecastEntry", new {idArticle = article.IdArticle, idCustomer = Model.IdClient,idCommercial = Model.IdCommercial, monthStart = monthStart, yearStart = yearStart, monthEnd = monthEnd, yearEnd = yearEnd, codeSAPClient = Model.CodeSAPCustomer, page = Model.TargetedPage, searchDescription = Model.SearchedProductDescription, searchCode = Model.SearchedProductCode, sortOrder = Model.SortType@* selectedStatus = Model.SelectedStatus *@ })'><i class="bi bi-trash3-fill collapse-icon text-danger"></i></a>
                                        }
                                    </td>
                                </tr>

                                <tr>
                                    <td colspan="12" class="hiddenRow p-0">
                                        <div class="collapse" id="AR_@article.CodeSAP" data-bs-parent="#myAccordion">
                                            <form asp-controller="ForecastEntry" asp-action="CustomersProducts" asp-route-id="@Model.CodeSAPCustomer" form-article="@article.CodeSAP">
                                                <input value="@Model.IdClient" asp-for="IdClient" hidden />
                                                <input value="@Model.IdCommercial" asp-for="IdCommercial" hidden/>
                                                <input value="@article.IdArticle" asp-for="IdArticle" hidden />
                                                <input asp-for="TargetedPage" value="" id="targetPageId_@article.CodeSAP" hidden/>
                                                <input asp-for="SortType" value="" id="sortTypeId" hidden/>
                                                <input type="text" class="form-control position-sticky" placeholder="" id="productSearchDescriptionToSend" asp-for="SearchedProductDescription" hidden />
                                                <input type="text" class="form-control position-sticky" placeholder="" id="productSearchCodeToSend" asp-for="SearchedProductCode" hidden />
                                                <input class="form-select col-4" aria-label="Default select example" id="entryStatusProToSend_@article.CodeSAP" asp-for="SelectedStatus" value="4" hidden/>
                                                <input type="text" id="collapsed_@article.CodeSAP" asp-for="CollapsedSubtableId" hidden/>
                                               
                                              
                                                <table class="table table-striped m-0">
                                                    <tr>
                                                        <th></th>
                                                        @for (var date = startDate.Date; date.Date <= endDate.Date; date = date.AddMonths(1))
                                                        {

                                                            <th> @monthList[@date.Month - 1] - @date.Year.ToString().Substring(@date.Year.ToString().Length - 2)</th>
                                                        }
                                                        <th><span class="price-total-style">Total</span></th>
                                                    </tr>

                                                    <tr class="forecastInputs">
                                                        <th class="subTableTitle">@Model.Localizer["subtable.forecasts"]</th>

                                                        @foreach (var prev in article.ListArticlePrevision)
                                                        {
                                                            @if(prev.Volume != 0)
                                                            {
                                                                <td><input class="form-control input-group-sm text-center input-values-forecasts dbVolume" asp-for="@prev.Volume" article-SAP="@article.CodeSAP" article-id="@prev.IdArticle" customer-id="@prev.IdClient" name="volume_@(prev.Mois)_@(prev.Annee)" old-values="@prev.Volume" type="number" min="0" max="1000000" /></td>
                                                            }
                                                            else
                                                            {
                                                                <td><input class="form-control input-group-sm text-center input-values-forecasts" asp-for="@prev.Volume" article-SAP="@article.CodeSAP" article-id="@prev.IdArticle" customer-id="@prev.IdClient" name="volume_@(prev.Mois)_@(prev.Annee)" old-values="@prev.Volume" type="number" min="0" max="1000000" /></td>
                                                            }
                                                        }
                                                        <td class="fw-bold align-middle">@article.ListArticlePrevision.Sum(p => p.Volume)</td>
                                                    </tr>
                                                    <tr>
                                                        <th class="subTableTitle">@Model.Localizer["subtable.Pricing"]</th>
                                                        @foreach (var prev in article.ListArticlePrevision)
                                                        {
                                                            @if (prev.Volume != 0)
                                                            {
                                                                <td class="align-middle">  @((prev.Volume * article.TarifArticle)?.ToString("N",nfiDecimalDB))</td>
                                                            }
                                                            else
                                                            {
                                                                <td class="align-middle">0</td>
                                                            }

                                                        }
                                                        <td class="fw-bold align-middle">@((article.ListArticlePrevision.Sum(p => p.Volume) * article.TarifArticle)?.ToString("N", nfiDecimalDB))</td>
                                                    </tr>

                                                    <tr>
                                                        <th class="subTableTitle">@Model.Localizer["subtable.forecasts"] N-1</th>

                                                        @foreach (var prev in article.ListArticlePrevisionN_un)
                                                        {
                                                            <td class="vol-PrevisionN_un align-middle" article-id="@article.IdArticle">@prev.Volume</td>

                                                        }
                                                        <td class="forecastToAdd pointer-cursor" article-id="@article.IdArticle"><i class="bi bi-arrow-up-square fs-4 arrow-copy"></i></td>
                                                    </tr>

                                                    <tr>
                                                        <th class="subTableTitle">@Model.Localizer["subtable.portfolios"]</th>
                                                        @foreach (var port in article.ListArticlePortefeuille)
                                                        {

                                                                <td class="align-middle">@port.Volume </td>
                                                        }
                                                        <td></td>
                                                    </tr>
                                                    <tr>
                                                        <th class="subTableTitle">@Model.Localizer["subtable.delivered"] N</th>
                                                        @foreach (var livreeN in article.ListArticleLivreeN)
                                                        {
                                                        

                                                                <td class="align-middle">@livreeN.Volume </td>
                                                     
                                                  

                                                        }
                                                        <td class="align-middle"></td>
                                                    </tr>
                                                    <tr>
                                                        <th class="subTableTitle">@Model.Localizer["subtable.delivered"] N-1</th>
                                                        @foreach (var livreeN_un in article.ListArticleLivreeN_un )
                                                        {
                                                            

                                                                <td class="align-middle vol-livreeN_un" article-id="@article.IdArticle">@livreeN_un.Volume</td>
                                                          
                                                        }

                                                        <td class="livresN1ToAdd pointer-cursor" article-id="@article.IdArticle"><i class="bi bi-arrow-up-square arrow-copy fs-4"></i></td>
                                                    </tr>
                                                    <tr>

                                                        <td>
                                                            <div class="d-flex align-items-center">
                                                                <label class="col-5 fw-bolder price-total-style">@Model.Localizer["subtable.Price"]</label>
                                                                <input class="input-group-sm price-input decimalInputPrice text-center" style="width:100px;outline:none !important;height:40px; border-radius:5px;" value="@article.TarifArticle?.ToString("N",nfiDecimalDB).Replace("\u00A0", " ")" step="any" name="TarifAEntered" pattern="@Model.RegexCultureDB" title="" id="price_@article.CodeSAP" article-SAP="@article.CodeSAP" required />
                                                            </div>
                                                        
                                                        </td>
                                                        <td colspan="@(endDate-startDate).Days" class="text-end">

                                                            <input class="undoChangesBtn sm-auto text-center forecast-cancel-button-style width-150" type="button" value="@Model.Localizer["page.cancelbtn"]" name="undoChanges" id="undoChanges_@article.CodeSAP">


                                                            <input class="saveForecastDB-btn sm-auto forecast-button-style width-150" type="submit" value="@Model.Localizer["page.confirmbtn"]" name="saveForecastDB" id="saveForecast_@article.CodeSAP" @if (Model.SaveTypeSelected == "Global") {<text>hidden</text> }>
                                                     
                                                           
                                                        </td>

                                                    </tr>
                                                </table>
                                            </form>
                                        </div>
                                    </td>

                                </tr>
                            }
                        }
                    </tbody>

                </table>
            </div>

            @if(Model.SaveTypeSelected == "Global")
            {
                <div class="row d-flex justify-content-end pe-4 py-2">
                    <input class="saveAllForecastDB-btn sm-auto forecast-button-style width-150 text-center" type="submit"  value="@Model.Localizer["page.confirmAllBtn"]" name="saveAllForecastDB">
                </div>
            }
           
                <div class=" p-container d-flex justify-content-between  border-top">


                    <div class="col-3 text-start d-none d-md-block">
                        @if (Model.Products.Count() == 15)
                        {
                            <span class="fw-bold">@Model.Localizer["pagination.nbProducts"] :  @(Model.Products.Count * Model.Products.PageNumber) / @Model.ProductsListTotal.Count</span>
                        }
                        else
                        {
                            <span class="fw-bold">@Model.Localizer["pagination.nbProducts"]:  @Model.ProductsListTotal.Count / @Model.ProductsListTotal.Count</span>
                        }

                    </div>

                        <div class="col-12 col-md-5 d-flex justify-content-center mt-2 mt-md-0">
                        <div class="pagination-container">
                            @if (Model.Products.PageNumber != 1 && Model.Products.PageNumber != 2)
                            {
                                <div>      <a id="page_1" class="pagination btn-link d-flex align-items-center justify-content-center fw-bold" target-page="1">1</a> </div>

                                <span class="align-self-end fw-bold fs-5">...</span>
                            }

                            @if (Model.Products.HasPreviousPage)
                            {
                                <div> <a id="page_@(Model.Products.PageNumber-1)" class="pagination btn-link d-flex align-items-center justify-content-center fw-bold" target-page="@(Model.Products.PageNumber-1)">@(Model.Products.PageNumber - 1)</a></div>

                            }
                            <div class="active">  <a id="page_@Model.Products.PageNumber" class="pagination btn-link d-flex align-items-center justify-content-center fw-bold" target-page="@Model.Products.PageNumber">@Model.Products.PageNumber</a></div>


                            @if (Model.Products.HasNextPage)
                            {
                                <div>     <a id="page_@(Model.Products.PageNumber+1)" class="pagination btn-link d-flex align-items-center justify-content-center fw-bold" target-page="@(Model.Products.PageNumber+1)">@(Model.Products.PageNumber + 1)</a> </div>

                            }

                            @if (Model.Products.PageNumber != Model.Products.PageCount && Model.Products.PageNumber != Model.Products.PageCount - 1 && Model.Products.PageCount != 0)
                            {
                                <span class="align-self-end fw-bold fs-5">...</span>
                                <div> <a id="page_@Model.Products.PageCount" class="pagination btn-link d-flex align-items-center justify-content-center fw-bold" target-page="@Model.Products.PageCount">@Model.Products.PageCount</a> </div>

                            }
                        </div>

                    </div>


                    <div class="col-2 text-end fw-bold d-none d-md-block">
                        @Model.Localizer["pagination.page"] @(Model.Products.PageCount < Model.Products.PageNumber ? 0 : Model.Products.PageNumber) / @Model.Products.PageCount
                    </div>


                </div>
          
      
        </div>
    </div>


}






